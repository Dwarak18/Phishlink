const s="http://localhost:8000";chrome.runtime.onInstalled.addListener(e=>{console.log("PhishShield extension installed/updated:",e.reason),e.reason==="install"&&(chrome.storage.sync.set({apiUrl:s,autoScan:!0,showNotifications:!0,riskThreshold:"medium"}),chrome.tabs.create({url:chrome.runtime.getURL("src/options.html?welcome=true")}))});chrome.runtime.onMessage.addListener((e,t,r)=>{switch(console.log("Background received message:",e),e.type){case"ANALYZE_EMAIL":return n(e.emailData).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0;case"GET_CURRENT_EMAIL":return i(t.tab.id).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0;case"SUBMIT_FEEDBACK":return u(e.feedback).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0;case"OAUTH_AUTHORIZE":return h(e.provider).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0;case"GET_SETTINGS":return chrome.storage.sync.get(null,o=>{r({success:!0,data:o})}),!0;case"UPDATE_SETTINGS":return chrome.storage.sync.set(e.settings,()=>{r({success:!0})}),!0;default:console.warn("Unknown message type:",e.type),r({success:!1,error:"Unknown message type"})}});async function n(e){try{const t=await c(),r=t.apiUrl||s,o=await fetch(`${r}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error(`API request failed: ${o.status} ${o.statusText}`);const a=await o.json();return await chrome.storage.local.set({[`analysis_${e.message_id||Date.now()}`]:{result:a,emailData:e,timestamp:Date.now()}}),t.showNotifications&&a.risk_level in["high","critical"]&&g(a),f(a.risk_level),a}catch(t){throw console.error("Email analysis failed:",t),t}}async function i(e){try{const[t]=await chrome.scripting.executeScript({target:{tabId:e},function:l});return t.result}catch(t){throw console.error("Failed to get current email:",t),new Error("Could not extract email data from current page")}}function l(){if(window.phishShieldExtractor)return window.phishShieldExtractor.getCurrentEmail();throw new Error("Email extractor not available")}async function u(e){try{const r=(await c()).apiUrl||s,o=await fetch(`${r}/feedback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error(`Failed to submit feedback: ${o.status}`);return await o.json()}catch(t){throw console.error("Feedback submission failed:",t),t}}async function h(e){try{if(e==="google")return await d();if(e==="microsoft")return await m();throw new Error("Unsupported OAuth provider")}catch(t){throw console.error("OAuth flow failed:",t),t}}async function d(){return new Promise((e,t)=>{chrome.identity.getAuthToken({interactive:!0},r=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}chrome.storage.local.set({googleAuthToken:r,googleAuthExpiry:Date.now()+3600*1e3}),e({token:r,provider:"google"})})})}async function m(){throw new Error("Microsoft OAuth not yet implemented")}function g(e){const t={low:"âš ï¸",medium:"ðŸš¨",high:"ðŸ”´",critical:"ðŸ’€"};chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:`${t[e.risk_level]} PhishShield Alert`,message:`High risk email detected! Risk level: ${e.risk_level.toUpperCase()}`,priority:2})}function f(e){const t={safe:{text:"âœ“",color:"#4CAF50"},low:{text:"!",color:"#FF9800"},medium:{text:"!!",color:"#FF5722"},high:{text:"!!!",color:"#F44336"},critical:{text:"ðŸ’€",color:"#B71C1C"}},r=t[e]||t.safe;chrome.action.setBadgeText({text:r.text}),chrome.action.setBadgeBackgroundColor({color:r.color}),setTimeout(()=>{chrome.action.setBadgeText({text:""})},1e4)}async function c(){return new Promise(e=>{chrome.storage.sync.get(null,t=>{e(t)})})}chrome.tabs.onUpdated.addListener((e,t,r)=>{t.status==="complete"&&r.url&&!r.url.includes("mail.google.com")&&!r.url.includes("outlook")&&chrome.action.setBadgeText({text:""})});chrome.alarms.create("cleanupAnalysisData",{periodInMinutes:1440});chrome.alarms.onAlarm.addListener(e=>{e.name==="cleanupAnalysisData"&&w()});async function w(){const e=await chrome.storage.local.get(null),t=Date.now()-7*24*60*60*1e3,r=Object.keys(e).filter(o=>o.startsWith("analysis_")?e[o].timestamp<t:!1);r.length>0&&(await chrome.storage.local.remove(r),console.log(`Cleaned up ${r.length} old analysis records`))}setInterval(async()=>{try{const t=(await c()).apiUrl||s,r=await fetch(`${t}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});r.ok||console.warn("API health check failed:",r.status)}catch(e){console.warn("API health check error:",e.message)}},5*60*1e3);console.log("PhishShield background service worker loaded");
