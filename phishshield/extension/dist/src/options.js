class i{constructor(){this.settings={},this.initialize()}async initialize(){console.log("Initializing PhishShield Options"),new URLSearchParams(window.location.search).get("welcome")==="true"&&this.showWelcomeSection(),await this.loadSettings(),this.setupEventListeners(),await this.loadTrustLists(),await this.loadStatistics(),this.testApiConnection()}showWelcomeSection(){const t=document.getElementById("welcome-section");t&&t.classList.remove("hidden")}async loadSettings(){try{this.settings=await chrome.storage.sync.get(null);const t={apiUrl:"http://localhost:8000",autoScan:!0,showNotifications:!0,riskThreshold:"medium",blockSuspiciousLinks:!1,debugMode:!1,analytics:!0};this.settings={...t,...this.settings},this.updateUI()}catch(t){console.error("Error loading settings:",t),this.showToast("Error loading settings","error")}}updateUI(){document.getElementById("api-url").value=this.settings.apiUrl||"",document.getElementById("auto-scan").checked=this.settings.autoScan??!0,document.getElementById("show-notifications").checked=this.settings.showNotifications??!0,document.getElementById("risk-threshold").value=this.settings.riskThreshold||"medium",document.getElementById("block-suspicious-links").checked=this.settings.blockSuspiciousLinks??!1,document.getElementById("debug-mode").checked=this.settings.debugMode??!1,document.getElementById("analytics").checked=this.settings.analytics??!0}setupEventListeners(){document.getElementById("api-url").addEventListener("change",t=>{this.saveSetting("apiUrl",t.target.value)}),document.getElementById("test-connection").addEventListener("click",()=>{this.testApiConnection()}),document.getElementById("auto-scan").addEventListener("change",t=>{this.saveSetting("autoScan",t.target.checked)}),document.getElementById("show-notifications").addEventListener("change",t=>{this.saveSetting("showNotifications",t.target.checked)}),document.getElementById("risk-threshold").addEventListener("change",t=>{this.saveSetting("riskThreshold",t.target.value)}),document.getElementById("block-suspicious-links").addEventListener("change",t=>{this.saveSetting("blockSuspiciousLinks",t.target.checked)}),document.getElementById("add-whitelist").addEventListener("click",()=>{this.addToTrustList("whitelist")}),document.getElementById("add-blacklist").addEventListener("click",()=>{this.addToTrustList("blacklist")}),document.getElementById("gmail-oauth").addEventListener("click",()=>{this.handleOAuth("google")}),document.getElementById("outlook-oauth").addEventListener("click",()=>{this.handleOAuth("microsoft")}),document.getElementById("debug-mode").addEventListener("change",t=>{this.saveSetting("debugMode",t.target.checked)}),document.getElementById("analytics").addEventListener("change",t=>{this.saveSetting("analytics",t.target.checked)}),document.getElementById("export-settings").addEventListener("click",()=>{this.exportSettings()}),document.getElementById("import-settings").addEventListener("click",()=>{document.getElementById("import-file").click()}),document.getElementById("import-file").addEventListener("change",t=>{this.importSettings(t.target.files[0])}),document.getElementById("reset-settings").addEventListener("click",()=>{this.resetSettings()}),document.getElementById("whitelist-input").addEventListener("keypress",t=>{t.key==="Enter"&&this.addToTrustList("whitelist")}),document.getElementById("blacklist-input").addEventListener("keypress",t=>{t.key==="Enter"&&this.addToTrustList("blacklist")})}async saveSetting(t,e){try{this.settings[t]=e,await chrome.storage.sync.set({[t]:e}),this.showToast("Settings saved","success")}catch(s){console.error("Error saving setting:",s),this.showToast("Error saving settings","error")}}async testApiConnection(){const t=document.getElementById("test-connection"),e=document.getElementById("connection-status"),s=this.settings.apiUrl||"http://localhost:8000";t.disabled=!0,t.textContent="Testing...",e.textContent="Testing...",e.className="status-indicator testing";try{const n=await fetch(`${s}/health`);if(n.ok){const o=await n.json();e.textContent=`✅ Connected (v${o.version})`,e.className="status-indicator success",this.showToast("API connection successful","success")}else throw new Error(`HTTP ${n.status}`)}catch(n){console.error("API connection test failed:",n),e.textContent="❌ Connection failed",e.className="status-indicator error",this.showToast(`API connection failed: ${n.message}`,"error")}finally{t.disabled=!1,t.textContent="Test Connection"}}async addToTrustList(t){const e=`${t}-input`,s=document.getElementById(e),n=s.value.trim();if(!n){this.showToast("Please enter an email address or domain","warning");return}if(!this.isValidEmailOrDomain(n)){this.showToast("Please enter a valid email address or domain","warning");return}try{const o=await this.sendMessage({type:"ADD_TO_TRUSTLIST",listType:t,email:n});if(o.success)s.value="",await this.loadTrustLists(),this.showToast(`Added to ${t}`,"success");else throw new Error(o.error||"Failed to add to trust list")}catch(o){console.error("Error adding to trust list:",o),this.showToast(`Error adding to ${t}: ${o.message}`,"error")}}async loadTrustLists(){try{const t=await this.sendMessage({type:"GET_TRUSTLISTS"});t.success&&(this.renderTrustList("whitelist",t.data.whitelist||[]),this.renderTrustList("blacklist",t.data.blacklist||[]))}catch(t){console.error("Error loading trust lists:",t)}}renderTrustList(t,e){const s=document.getElementById(`${t}-items`);s.innerHTML="",e.forEach(n=>{const o=document.createElement("li");o.innerHTML=`
                <span class="trust-item-email">${n.email_address}</span>
                <button class="remove-btn" data-type="${t}" data-email="${n.email_address}">
                    Remove
                </button>
            `,s.appendChild(o)}),s.querySelectorAll(".remove-btn").forEach(n=>{n.addEventListener("click",o=>{this.removeFromTrustList(o.target.dataset.type,o.target.dataset.email)})})}async removeFromTrustList(t,e){try{const s=await this.sendMessage({type:"REMOVE_FROM_TRUSTLIST",listType:t,email:e});if(s.success)await this.loadTrustLists(),this.showToast(`Removed from ${t}`,"success");else throw new Error(s.error||"Failed to remove from trust list")}catch(s){console.error("Error removing from trust list:",s),this.showToast(`Error removing from ${t}: ${s.message}`,"error")}}async handleOAuth(t){const e=document.getElementById(`${t==="google"?"gmail":"outlook"}-oauth`),s=document.getElementById(`${t==="google"?"gmail":"outlook"}-status`);e.disabled=!0,e.textContent="Connecting...";try{const n=await this.sendMessage({type:"OAUTH_AUTHORIZE",provider:t});if(n.success)s.textContent="✅ Connected",s.className="status-indicator success",e.textContent="Disconnect",this.showToast(`${t==="google"?"Gmail":"Outlook"} connected successfully`,"success");else throw new Error(n.error||"OAuth failed")}catch(n){console.error("OAuth error:",n),s.textContent="❌ Failed",s.className="status-indicator error",this.showToast(`${t==="google"?"Gmail":"Outlook"} connection failed: ${n.message}`,"error")}finally{e.disabled=!1,e.textContent==="Connecting..."&&(e.textContent=t==="google"?"Connect Gmail":"Connect Outlook")}}async loadStatistics(){try{const t=await this.sendMessage({type:"GET_STATISTICS"});if(t.success){const e=t.data;document.getElementById("total-scans").textContent=e.totalScans||0,document.getElementById("threats-blocked").textContent=e.threatsBlocked||0,document.getElementById("avg-risk-score").textContent=e.avgRiskScore||0,document.getElementById("last-scan").textContent=e.lastScan||"Never"}}catch(t){console.error("Error loading statistics:",t)}}exportSettings(){const t={...this.settings,exportDate:new Date().toISOString(),version:"1.0.0"},e=JSON.stringify(t,null,2),s=new Blob([e],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(s),n.download=`phishshield-settings-${new Date().toISOString().split("T")[0]}.json`,n.click(),this.showToast("Settings exported","success")}async importSettings(t){if(t)try{const e=await t.text(),s=JSON.parse(e);if(!s.version)throw new Error("Invalid settings file format");delete s.exportDate,delete s.version,await chrome.storage.sync.set(s),this.settings={...this.settings,...s},this.updateUI(),this.showToast("Settings imported successfully","success")}catch(e){console.error("Error importing settings:",e),this.showToast("Error importing settings: "+e.message,"error")}}async resetSettings(){if(confirm("Are you sure you want to reset all settings to defaults? This action cannot be undone."))try{await chrome.storage.sync.clear(),await this.loadSettings(),this.showToast("Settings reset to defaults","success")}catch(t){console.error("Error resetting settings:",t),this.showToast("Error resetting settings","error")}}isValidEmailOrDomain(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||/^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.([a-zA-Z]{2,})+$/.test(t)?!0:/^\*@[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.([a-zA-Z]{2,})+$/.test(t)}async sendMessage(t){return new Promise(e=>{chrome.runtime.sendMessage(t,s=>{e(s||{success:!1,error:"No response"})})})}showToast(t,e="info"){const s=document.getElementById("toast-container"),n=document.createElement("div");n.className=`toast toast-${e}`,n.textContent=t,s.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}}document.addEventListener("DOMContentLoaded",()=>{new i});
